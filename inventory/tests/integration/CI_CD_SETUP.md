# üîß CI/CD Setup –¥–ª—è Integration Tests

## ‚úÖ –ß—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Ç–µ—Å—Ç–æ–≤

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
1. **Docker** –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω
   ```bash
   docker ps  # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ Docker —Ä–∞–±–æ—Ç–∞–µ—Ç
   ```

2. **Environment —Ñ–∞–π–ª—ã** –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã
   ```bash
   task env:generate
   ```

3. **–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤**
   ```bash
   task test-integration MODULES=inventory
   # –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é:
   go test -v -timeout=20m -tags=integration ./inventory/tests/integration/...
   ```

### CI/CD (GitHub Actions)

Workflow —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ `.github/workflows/test-integration-reusable.yml`:

1. ‚úÖ **Docker Buildx** –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
2. ‚úÖ **Environment —Ñ–∞–π–ª—ã** –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ `task env:generate`
3. ‚úÖ **–¢–µ—Å—Ç—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è** —á–µ—Ä–µ–∑ `task test-integration`

## üö® –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ 1: "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å .env —Ñ–∞–π–ª"
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã environment —Ñ–∞–π–ª—ã

**–†–µ—à–µ–Ω–∏–µ:**
```bash
task env:generate
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:
```bash
# 1. –°–æ–∑–¥–∞–π—Ç–µ –±–∞–∑–æ–≤—ã–π .env –∏–∑ —à–∞–±–ª–æ–Ω–∞
cp deploy/env/.env.template deploy/env/.env

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
cd deploy/env
SERVICES=inventory ./generate-env.sh
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: "rootless Docker not found" –∏–ª–∏ "docker: command not found"
**–ü—Ä–∏—á–∏–Ω–∞:** Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω

**–†–µ—à–µ–Ω–∏–µ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Docker
docker ps

# –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker:
# - macOS: Docker Desktop
# - Linux: Docker Engine
# - Windows: Docker Desktop –∏–ª–∏ WSL2 —Å Docker
```

**–†–µ—à–µ–Ω–∏–µ –¥–ª—è CI/CD:**
- GitHub Actions: Docker —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ workflow (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `docker/setup-buildx-action@v3`)
- GitLab CI: –¥–æ–±–∞–≤—å—Ç–µ `services: - docker:dind` –≤ `.gitlab-ci.yml`
- Jenkins: —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Jenkins –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ Docker socket

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –¢–µ—Å—Ç—ã –ø–∞–¥–∞—é—Ç —Å timeout
**–ü—Ä–∏—á–∏–Ω–∞:** –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ —Ç—Ä–µ–±—É–µ—Ç —Å–±–æ—Ä–∫–∏ Docker –æ–±—Ä–∞–∑–∞ (~3-5 –º–∏–Ω—É—Ç)

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –£–≤–µ–ª–∏—á—å—Ç–µ timeout
go test -v -timeout=30m -tags=integration ./inventory/tests/integration/...
```

–í CI/CD timeout —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ 20 –º–∏–Ω—É—Ç –≤ `Taskfile.yml`.

### –ü—Ä–æ–±–ª–µ–º–∞ 4: "Cannot connect to Docker daemon"
**–ü—Ä–∏—á–∏–Ω–∞:** Docker daemon –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –Ω–µ—Ç –ø—Ä–∞–≤

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# Linux: –¥–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É docker
sudo usermod -aG docker $USER
newgrp docker

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ socket
ls -la /var/run/docker.sock
```

## üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

```
inventory/tests/integration/
‚îú‚îÄ‚îÄ CI_CD_SETUP.md          # –≠—Ç–æ—Ç —Ñ–∞–π–ª - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è CI/CD
‚îú‚îÄ‚îÄ HOW_TO_RUN.md           # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
‚îú‚îÄ‚îÄ suite_test.go           # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ test suite (BeforeSuite/AfterSuite)
‚îú‚îÄ‚îÄ inventory_test.go       # –°–∞–º–∏ —Ç–µ—Å—Ç—ã
‚îú‚îÄ‚îÄ setup.go                # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è (Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã)
‚îú‚îÄ‚îÄ teardown.go             # –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤
‚îú‚îÄ‚îÄ test_environment.go     # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
‚îî‚îÄ‚îÄ constants.go            # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
```

## üîç –ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–µ—Å—Ç—ã

1. **BeforeSuite** (–æ–¥–∏–Ω —Ä–∞–∑ –ø–µ—Ä–µ–¥ –≤—Å–µ–º–∏ —Ç–µ—Å—Ç–∞–º–∏):
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç `.env` —Ñ–∞–π–ª –∏–∑ `deploy/compose/inventory/.env`
   - –°–æ–∑–¥–∞–µ—Ç Docker —Å–µ—Ç—å
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç MongoDB –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
   - –°–æ–±–∏—Ä–∞–µ—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
   - –û–∂–∏–¥–∞–µ—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (wait strategy –Ω–∞ gRPC –ø–æ—Ä—Ç—É)

2. **BeforeEach** (–ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º):
   - –°–æ–∑–¥–∞–µ—Ç gRPC –∫–ª–∏–µ–Ω—Ç –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é

3. **–¢–µ—Å—Ç—ã**:
   - –í—Å—Ç–∞–≤–ª—è—é—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ MongoDB
   - –í—ã–∑—ã–≤–∞—é—Ç gRPC –º–µ—Ç–æ–¥—ã
   - –ü—Ä–æ–≤–µ—Ä—è—é—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

4. **AfterEach** (–ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞):
   - –û—á–∏—â–∞–µ—Ç –∫–æ–ª–ª–µ–∫—Ü–∏—é `parts` –≤ MongoDB

5. **AfterSuite** (–æ–¥–∏–Ω —Ä–∞–∑ –ø–æ—Å–ª–µ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤):
   - –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   - –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä MongoDB
   - –£–¥–∞–ª—è–µ—Ç Docker —Å–µ—Ç—å

## üí° –°–æ–≤–µ—Ç—ã –¥–ª—è CI/CD

### 1. –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ Docker –æ–±—Ä–∞–∑–æ–≤
–í GitHub Actions —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ:
```yaml
- name: üß© Set up Docker cache
  uses: actions/cache@v4
  with:
    path: /tmp/.buildx-cache
    key: ${{ runner.os }}-buildx-${{ github.sha }}
    restore-keys: |
      ${{ runner.os }}-buildx-
```

### 2. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
–ï—Å–ª–∏ —É –≤–∞—Å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–æ–¥—É–ª–µ–π, –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–µ—Å—Ç—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ:
```yaml
strategy:
  matrix:
    module: [inventory, order, payment]
```

### 3. –û—á–∏—Å—Ç–∫–∞ Docker —Ä–µ—Å—É—Ä—Å–æ–≤
–ü–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—á–∏—Å—Ç–∏—Ç—å dangling containers:
```bash
docker container prune -f
```
–£–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –≤ GitHub Actions workflow.

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫:**
- –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞: ~3-5 –º–∏–Ω—É—Ç
- –ó–∞–ø—É—Å–∫ MongoDB: ~5 —Å–µ–∫—É–Ω–¥
- –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ~2-6 —Å–µ–∫—É–Ω–¥ (retry –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MongoDB)
- –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤: ~10-30 —Å–µ–∫—É–Ω–¥
- **–ò—Ç–æ–≥–æ: ~4-7 –º–∏–Ω—É—Ç**

**–ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—É—Å–∫–∏ (—Å –∫–µ—à–µ–º):**
- –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞: ~10-30 —Å–µ–∫—É–Ω–¥ (–∫–µ—à —Å–ª–æ–µ–≤)
- –ó–∞–ø—É—Å–∫ MongoDB: ~5 —Å–µ–∫—É–Ω–¥
- –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ~2-6 —Å–µ–∫—É–Ω–¥
- –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤: ~10-30 —Å–µ–∫—É–Ω–¥
- **–ò—Ç–æ–≥–æ: ~30-60 —Å–µ–∫—É–Ω–¥**

## üéØ –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CI/CD

- [ ] Docker –¥–æ—Å—Ç—É–ø–µ–Ω –≤ CI/CD environment
- [ ] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è `.env` —Ñ–∞–π–ª–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –≤ pipeline
- [ ] Timeout –¥–ª—è —Ç–µ—Å—Ç–æ–≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω >= 20 –º–∏–Ω—É—Ç
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ Docker –æ–±—Ä–∞–∑–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ Docker —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ, —á—Ç–æ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –ª–æ–∫–∞–ª—å–Ω–æ
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ, —á—Ç–æ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –≤ CI/CD

## üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Testcontainers Documentation](https://golang.testcontainers.org/)
- [GitHub Actions - Docker](https://docs.github.com/en/actions/using-containerized-services/about-service-containers)
- [Ginkgo Testing Framework](https://onsi.github.io/ginkgo/)
- [Gomega Matchers](https://onsi.github.io/gomega/)

---

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Ç–µ—Å—Ç–æ–≤ - –æ–Ω–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º —à–∞–≥–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è.
