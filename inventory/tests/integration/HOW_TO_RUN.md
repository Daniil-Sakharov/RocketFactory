# üß™ –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å E2E —Ç–µ—Å—Ç—ã –¥–ª—è Inventory Service

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ CI/CD

### 1. **–°–æ–∑–¥–∞–Ω –≥–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**
- –§–∞–π–ª: `deploy/env/.env`
- –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è service-specific .env —Ñ–∞–π–ª–æ–≤

### 2. **–°–æ–∑–¥–∞–Ω .env —Ñ–∞–π–ª –¥–ª—è Inventory —Ç–µ—Å—Ç–æ–≤**
- –ü—É—Ç—å: `deploy/compose/inventory/.env`
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —à–∞–±–ª–æ–Ω–∞ `deploy/env/inventory.env.template`
- –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è MongoDB –∏ gRPC

### 3. **MongoDB retry —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω**
- –§–∞–π–ª: `inventory/internal/app/di.go`
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ MongoDB **20 —Ä–∞–∑** —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º **3 —Å–µ–∫—É–Ω–¥—ã**
- –≠—Ç–æ –¥–∞–µ—Ç MongoDB –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ (–¥–æ 60 —Å–µ–∫—É–Ω–¥)

### 4. **–ù–∞—Å—Ç—Ä–æ–µ–Ω GitHub Workflow**
- Workflow –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç .env —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ `task env:generate`
- –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ç–µ—Å—Ç—ã —Å Docker —á–µ—Ä–µ–∑ testcontainers
- –û—á–∏—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤

### 5. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è**
–í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–æ–≤:
- `GRPC_HOST`, `GRPC_PORT` - –¥–ª—è gRPC —Å–µ—Ä–≤–µ—Ä–∞
- `LOGGER_LEVEL`, `LOGGER_AS_JSON` - –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- `MONGO_IMAGE_NAME` - –æ–±—Ä–∞–∑ MongoDB –¥–ª—è testcontainers
- `MONGO_HOST`, `MONGO_PORT`, `MONGO_DATABASE` - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MongoDB
- `MONGO_AUTH_DB`, `MONGO_INITDB_ROOT_USERNAME`, `MONGO_INITDB_ROOT_PASSWORD` - –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

---

## üöÄ –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã

### –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ GitHub Actions (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ CI/CD)

–¢–µ—Å—Ç—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ push –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ pull request:

```yaml
# Workflow –≤—ã–ø–æ–ª–Ω—è–µ—Ç:
1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—é .env —Ñ–∞–π–ª–æ–≤: task env:generate
2. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤: task test-integration MODULES=inventory
3. –û—á–∏—Å—Ç–∫—É Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
```

### –°–ø–æ—Å–æ–± 2: –õ–æ–∫–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ Taskfile (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# 1. –£–±–µ–¥–∏—Å—å, —á—Ç–æ Docker –∑–∞–ø—É—â–µ–Ω
docker ps

# 2. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π .env —Ñ–∞–π–ª—ã (–æ–¥–∏–Ω —Ä–∞–∑)
task env:generate

# 3. –ó–∞–ø—É—Å—Ç–∏ —Ç–µ—Å—Ç—ã
task test-integration MODULES=inventory
```

### –°–ø–æ—Å–æ–± 3: –ù–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ go test

```bash
# 1. –£–±–µ–¥–∏—Å—å —á—Ç–æ .env —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
ls deploy/compose/inventory/.env

# 2. –ò–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞, –∑–∞–ø—É—Å—Ç–∏ —Å —Ç–µ–≥–æ–º integration
cd inventory/tests/integration
go test -v -timeout=20m -tags=integration .
```

**–í–∞–∂–Ω–æ:** 
- `-timeout=20m` –Ω—É–∂–µ–Ω –¥–ª—è —Å–±–æ—Ä–∫–∏ Docker –æ–±—Ä–∞–∑–∞ (3-5 –º–∏–Ω—É—Ç –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ)
- –¢–µ—Å—Ç—ã —Ç—Ä–µ–±—É—é—Ç Docker –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è testcontainers
- .env —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –≤ `deploy/compose/inventory/.env`

---

## üîç –ï—Å–ª–∏ —Ç–µ—Å—Ç—ã –≤—Å–µ –µ—â–µ –ø–∞–¥–∞—é—Ç

### 1. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ Docker –∑–∞–ø—É—â–µ–Ω

```bash
docker ps
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π)
```

### 2. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–∞

–í **–¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ** –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤:

```bash
# –°–º–æ—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker ps --filter "label=org.testcontainers=true"

# –°–º–æ—Ç—Ä–∏ –ª–æ–≥–∏ MongoDB
docker logs <mongo_container_id>

# –°–º–æ—Ç—Ä–∏ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
docker logs <app_container_id>
```

### 3. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ –æ–¥–Ω–æ–π —Å–µ—Ç–∏

```bash
# –ù–∞–π–¥–∏ —Å–µ—Ç—å
docker network ls | grep inventory

# –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ —Å–µ—Ç–∏
docker network inspect <network_name>
```

### 4. –í—Ä—É—á–Ω—É—é –ø—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ MongoDB

```bash
# 1. –°–æ–∑–¥–∞–π —Å–µ—Ç—å
docker network create test-network

# 2. –ó–∞–ø—É—Å—Ç–∏ MongoDB
docker run -d --name test-mongo \
  --network test-network \
  -e MONGO_INITDB_ROOT_USERNAME=inventory-user \
  -e MONGO_INITDB_ROOT_PASSWORD=inventory-password \
  mongo:8.0

# 3. –ó–∞–ø—É—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
docker run --rm \
  --network test-network \
  -e GRPC_PORT=50051 \
  -e MONGO_HOST=test-mongo \
  -e MONGO_PORT=27017 \
  -e MONGO_DATABASE=inventory-service \
  -e MONGO_INITDB_ROOT_USERNAME=inventory-user \
  -e MONGO_INITDB_ROOT_PASSWORD=inventory-password \
  -e MONGO_AUTH_DB=admin \
  -e LOGGER_LEVEL=debug \
  -e LOGGER_AS_JSON=true \
  test-inventory:latest

# –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ MongoDB —á–µ—Ä–µ–∑ 1-2 –ø–æ–ø—ã—Ç–∫–∏
# –í –ª–æ–≥–∞—Ö —É–≤–∏–¥–∏—à—å: "Successfully connected to MongoDB (attempt X)"
```

### 5. –û—á–∏—Å—Ç–∏ Docker –∫–µ—à (–µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç)

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏ –≤—Å–µ testcontainers
docker ps -a --filter "label=org.testcontainers=true" --format "{{.ID}}" | xargs -r docker rm -f

# –£–¥–∞–ª–∏ —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã
docker images | grep inventory | awk '{print $3}' | xargs -r docker rmi -f

# –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏ –æ–±—Ä–∞–∑
docker build -f deploy/docker/inventory/Dockerfile -t test-inventory:latest .
```

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π —Ç–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã:

1. ‚úÖ **–°–æ–∑–¥–∞—Ç—å Docker —Å–µ—Ç—å** (~1 —Å–µ–∫—É–Ω–¥–∞)
2. ‚úÖ **–ó–∞–ø—É—Å—Ç–∏—Ç—å MongoDB –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä** (~5 —Å–µ–∫—É–Ω–¥)
3. ‚úÖ **–°–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** (~3-5 –º–∏–Ω—É—Ç –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ, –ø–æ—Ç–æ–º –±—ã—Å—Ç—Ä–µ–µ –±–ª–∞–≥–æ–¥–∞—Ä—è –∫–µ—à—É)
4. ‚úÖ **–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è** (~2 —Å–µ–∫—É–Ω–¥—ã)
5. ‚úÖ **–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ MongoDB** (1-3 –ø–æ–ø—ã—Ç–∫–∏, ~2-6 —Å–µ–∫—É–Ω–¥)
6. ‚úÖ **–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã** (~10-30 —Å–µ–∫—É–Ω–¥)
7. ‚úÖ **–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã** (~2 —Å–µ–∫—É–Ω–¥—ã)

**–û–±—â–µ–µ –≤—Ä–µ–º—è**: 4-7 –º–∏–Ω—É—Ç –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ, 30-60 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö (–±–ª–∞–≥–æ–¥–∞—Ä—è –∫–µ—à—É Docker).

---

## üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏

- **–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –≤—Å–µ–≥–¥–∞ –¥–æ–ª–≥–∏–π** ‚Äî Docker —Å–∫–∞—á–∏–≤–∞–µ—Ç –æ–±—Ä–∞–∑—ã –∏ —Å–æ–±–∏—Ä–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
- **–ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—É—Å–∫–∏ –±—ã—Å—Ç—Ä—ã–µ** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–µ—à
- **–ï—Å–ª–∏ —Ç–∞–π–º–∞—É—Ç**: —É–≤–µ–ª–∏—á—å `startupTimeout` –≤ `setup.go` (—Å–µ–π—á–∞—Å 5 –º–∏–Ω—É—Ç)
- **–ï—Å–ª–∏ MongoDB –Ω–µ —É—Å–ø–µ–≤–∞–µ—Ç —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å**: —É–≤–µ–ª–∏—á—å `maxRetries` –≤ `di.go` (—Å–µ–π—á–∞—Å 10 –ø–æ–ø—ã—Ç–æ–∫)

---

## üéØ –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è

1. **–ü–æ—á–µ–º—É –Ω—É–∂–µ–Ω retry –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ MongoDB?**
2. **–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ–∫–∞–∂—É—Ç—Å—è –≤ —Ä–∞–∑–Ω—ã—Ö Docker —Å–µ—Ç—è—Ö?**
3. **–ó–∞—á–µ–º –Ω—É–∂–µ–Ω build tag `//go:build integration`?**

–£–¥–∞—á–∏! üöÄ

