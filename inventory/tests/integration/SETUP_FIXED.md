# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ E2E —Ç–µ—Å—Ç–æ–≤ –¥–ª—è CI/CD

## üîç –ü—Ä–æ–±–ª–µ–º–∞

E2E —Ç–µ—Å—Ç—ã –≤ –ø–∞–ø–∫–µ `inventory/tests` –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–∏ –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö `.env` —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

### –û—à–∏–±–∫–∞
```
FATAL: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å .env —Ñ–∞–π–ª
error: open ../../../deploy/compose/inventory/.env: no such file or directory
```

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –°–æ–∑–¥–∞–Ω –º–∞—Å—Ç–µ—Ä —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
**–§–∞–π–ª:** `/workspace/deploy/env/.env`

–°–æ–∑–¥–∞–Ω –∏–∑ —à–∞–±–ª–æ–Ω–∞ `.env.template`, —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:
- INVENTORY —Å–µ—Ä–≤–∏—Å (MongoDB, gRPC)
- ORDER —Å–µ—Ä–≤–∏—Å (PostgreSQL, HTTP, gRPC –∫–ª–∏–µ–Ω—Ç—ã)
- PAYMENT —Å–µ—Ä–≤–∏—Å (gRPC)

### 2. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã .env —Ñ–∞–π–ª—ã –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤
**–ö–æ–º–∞–Ω–¥–∞:** `task env:generate`

–°–æ–∑–¥–∞–Ω—ã —Ñ–∞–π–ª—ã:
- ‚úÖ `/workspace/deploy/compose/inventory/.env`
- ‚úÖ `/workspace/deploy/compose/order/.env`
- ‚úÖ `/workspace/deploy/compose/payment/.env`

–≠—Ç–∏ —Ñ–∞–π–ª—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤ —Å –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ –º–∞—Å—Ç–µ—Ä —Ñ–∞–π–ª–∞.

### 3. –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è .gitignore
`.env` —Ñ–∞–π–ª—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è git (–Ω–µ –∫–æ–º–º–∏—Ç—è—Ç—Å—è), —Ç–∞–∫ –∫–∞–∫:
- –®–∞–±–ª–æ–Ω—ã `.env.template` —É–∂–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ ‚úì
- CI/CD –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç `.env` —Ñ–∞–π–ª—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚úì
- –°–µ–∫—Ä–µ—Ç—ã –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ‚úì

## üöÄ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç CI/CD

### Workflow: `.github/workflows/test-integration-reusable.yml`

```yaml
# 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Task
- name: üìå Install Task
  uses: arduino/setup-task@v2.0.0

# 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è .env —Ñ–∞–π–ª–æ–≤
- name: üìÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è .env —Ñ–∞–π–ª–æ–≤
  env:
    SERVICES: "inventory,order,payment"
  run: task env:generate

# 3. –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
- name: üß™ Run integration tests via Taskfile
  env:
    MODULES: ${{ inputs.modules }}
  run: task test-integration
```

## üìù –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```
deploy/
  env/
    .env                      # ‚úÖ –ú–∞—Å—Ç–µ—Ä —Ñ–∞–π–ª (—Å–æ–∑–¥–∞–µ—Ç—Å—è –∏–∑ .env.template)
    .env.template             # –®–∞–±–ª–æ–Ω –º–∞—Å—Ç–µ—Ä —Ñ–∞–π–ª–∞ (–≤ git)
    inventory.env.template    # –®–∞–±–ª–æ–Ω –¥–ª—è inventory (–≤ git)
    order.env.template        # –®–∞–±–ª–æ–Ω –¥–ª—è order (–≤ git)
    payment.env.template      # –®–∞–±–ª–æ–Ω –¥–ª—è payment (–≤ git)
    generate-env.sh           # –°–∫—Ä–∏–ø—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–≤ git)
  compose/
    inventory/
      .env                    # ‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª (–Ω–µ –≤ git)
      docker-compose.yml
    order/
      .env                    # ‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª (–Ω–µ –≤ git)
      docker-compose.yml
    payment/
      .env                    # ‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª (–Ω–µ –≤ git)
```

## üß™ –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –ª–æ–∫–∞–ª—å–Ω–æ

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
1. Docker –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
2. Go 1.24+ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
3. Task —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ go-task)

### –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ Task (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º .env —Ñ–∞–π–ª—ã (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å–¥–µ–ª–∞–ª–∏)
task env:generate

# 2. –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
task test-integration MODULES=inventory
```

### –°–ø–æ—Å–æ–± 2: –ù–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ Go

```bash
# 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º .env —Ñ–∞–π–ª—ã –≤—Ä—É—á–Ω—É—é
cd deploy/env
export ENV_SUBST=$HOME/go/bin/envsubst
export SERVICES="inventory,order,payment"
./generate-env.sh

# 2. –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
cd /workspace/inventory/tests/integration
go test -v -timeout=20m -tags=integration .
```

### –°–ø–æ—Å–æ–± 3: –ï—Å–ª–∏ Task –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

```bash
# 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å envsubst
go install github.com/a8m/envsubst/cmd/envsubst@v1.4.3

# 2. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å .env —Ñ–∞–π–ª—ã
cd /workspace
export ENV_SUBST=$HOME/go/bin/envsubst
export SERVICES="inventory,order,payment"
./deploy/env/generate-env.sh

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
cd inventory/tests/integration
go test -v -timeout=20m -tags=integration .
```

## ‚öôÔ∏è –ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è

### –¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç:
1. ‚úÖ **ListParts** - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–µ—Ç–∞–ª–µ–π
   - –ë–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ UUID
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

2. ‚úÖ **GetPart** - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–∏ –ø–æ UUID
   - –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –¥–µ—Ç–∞–ª–∏
   - –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –¥–µ—Ç–∞–ª–∏

3. ‚úÖ **–ü–æ–ª–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π** - –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç
   - –í—Å—Ç–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–µ—Ç–∞–ª–µ–π
   - –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –¥–µ—Ç–∞–ª–∏
   - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

## üê≥ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è —Ç–µ—Å—Ç–æ–≤

–¢–µ—Å—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç –∏ —É–¥–∞–ª—è—é—Ç:
- üóÑÔ∏è MongoDB –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π)
- üöÄ Inventory App –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (gRPC —Å–µ—Ä–≤–∏—Å)
- üåê Docker —Å–µ—Ç—å (–¥–ª—è —Å–≤—è–∑–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤)

**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫: ~3-5 –º–∏–Ω—É—Ç (—Å–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞)
- –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—É—Å–∫–∏: ~30-60 —Å–µ–∫—É–Ω–¥ (–∫–µ—à Docker)

## üìä –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤

### MongoDB
```env
MONGO_IMAGE_NAME=mongo:8.0
MONGO_HOST=mongodb-container-name
MONGO_PORT=27017
MONGO_DATABASE=inventory
MONGO_AUTH_DB=admin
MONGO_INITDB_ROOT_USERNAME=inventory_admin
MONGO_INITDB_ROOT_PASSWORD=inventory_secret
```

### gRPC Server
```env
GRPC_HOST=0.0.0.0
GRPC_PORT=50051
```

### Logger
```env
LOGGER_LEVEL=debug
LOGGER_AS_JSON=true
```

## ‚ú® –ß—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç

1. ‚úÖ CI/CD –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç .env —Ñ–∞–π–ª—ã
2. ‚úÖ –¢–µ—Å—Ç—ã –Ω–∞—Ö–æ–¥—è—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
3. ‚úÖ .env —Ñ–∞–π–ª—ã –Ω–µ –∫–æ–º–º–∏—Ç—è—Ç—Å—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
4. ‚úÖ –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
5. ‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏–º–µ—é—Ç –µ–¥–∏–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–î–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ –≤ CI/CD:
1. Push –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –≤–µ—Ç–∫—É
2. CI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç Task
   - –°–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç .env —Ñ–∞–π–ª—ã
   - –ó–∞–ø—É—Å—Ç–∏—Ç Docker
   - –í—ã–ø–æ–ª–Ω–∏—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

## üí° –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–õ–æ–∫–∞–ª—å–Ω–æ**: Docker –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω
2. **CI/CD**: Docker –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ GitHub Actions
3. **Timeout**: –¢–µ—Å—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç timeout 20 –º–∏–Ω—É—Ç (–ø–µ—Ä–≤–∞—è —Å–±–æ—Ä–∫–∞ –¥–æ–ª–≥–∞—è)
4. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: Docker Buildx –∫–µ—à–∏—Ä—É–µ—Ç —Å–ª–æ–∏ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏
5. **–û—á–∏—Å—Ç–∫–∞**: –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤

## üîß –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞: ".env file not found"
```bash
# –†–µ—à–µ–Ω–∏–µ: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å .env —Ñ–∞–π–ª—ã
task env:generate
```

### –û—à–∏–±–∫–∞: "Docker not found"
```bash
# –†–µ—à–µ–Ω–∏–µ: –ó–∞–ø—É—Å—Ç–∏—Ç—å Docker
docker ps  # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Docker —Ä–∞–±–æ—Ç–∞–µ—Ç
```

### –û—à–∏–±–∫–∞: "timeout"
```bash
# –†–µ—à–µ–Ω–∏–µ: –£–≤–µ–ª–∏—á–∏—Ç—å timeout –∏–ª–∏ –æ—á–∏—Å—Ç–∏—Ç—å Docker –∫–µ—à
go test -v -timeout=30m -tags=integration .
```

### –¢–µ—Å—Ç—ã –ø–∞–¥–∞—é—Ç —Å "connection refused"
```bash
# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤ –æ–¥–Ω–æ–π —Å–µ—Ç–∏
docker network inspect inventory-service
```

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [Taskfile.yml](/Taskfile.yml) - –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–±–æ—Ä–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- [HOW_TO_RUN.md](/inventory/tests/integration/HOW_TO_RUN.md) - –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É
- [.github/workflows/test-integration-reusable.yml](/.github/workflows/test-integration-reusable.yml) - CI/CD workflow

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞, CI/CD –¥–æ–ª–∂–Ω—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —É—Å–ø–µ—à–Ω–æ
